<% 
require 'yaml'
server_yaml = '.kitchen/wsus-server-windows-2016.yml'
%>
---
driver:
  name: ec2
  region: eu-west-1
  instance_type: m5.xlarge
  shared_credentials_profile: <%= ENV['AWS_PROFILE'] %>
  retryable_tries: 120
  retryable_sleep: 5

provisioner:
  name: chef_zero

verifier:
  name: inspec

platforms:
  - name: windows-2016

suites:
  - name: wsus_server
    provisioner:
      named_run_list: wsus_server
    verifier:
      inspec_tests:
        - test/integration/default
    attributes:
      wsus_server:
        freeze: 
          name: 'kitchen_windows2016'
  - name: wsus_client
    provisioner:
      named_run_list: wsus_client
    verifier:
      inspec_tests:
        - test/integration/default
    attributes:
      wsus_client:
        wsus_server: 'http://<%= File.exists?(server_yaml) ? YAML.load_file(server_yaml)["hostname"] || 'wsus-server' : 'wsus-server' %>:8530'
        update_group: 'kitchen_windows2016'
